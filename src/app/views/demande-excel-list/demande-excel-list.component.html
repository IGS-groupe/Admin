<div class="wrap" *ngIf="demandeId > 0; else missingId">
  <!-- Header / Toolbar -->
<!-- Top toolbar / header -->
<div class="card header-card" role="region" aria-label="Demande header">
  <div class="title-group">
    <!-- Folder/Sheet icon -->
    <svg class="title-icon" width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M20 6h-8l-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2Z" fill="currentColor"/>
    </svg>
    <div>
      <h2 class="title">Demande #{{ demandeId }} — Excel files</h2>
      <div class="subtitle">Manage uploads and status for this request.</div>
    </div>
  </div>

  <div class="toolbar-actions">
    <button class="btn btn-ghost" (click)="loadFiles()" [disabled]="loading" title="Refresh list">
      <!-- Refresh icon -->
      <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M17.65 6.35A7.95 7.95 0 0 0 12 4V1L7 6l5 5V7a5 5 0 1 1-4.9 6.1H5.02A7 7 0 1 0 17.65 6.35Z" fill="currentColor"/>
      </svg>
      <span>Refresh</span>
    </button>
  </div>
</div>

<!-- Status controls -->




  <!-- Upload zone -->
 <div class="card" role="region" aria-label="Upload Excel files">
  <!-- Header -->
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;">
    <div style="display:flex;align-items:center;gap:10px;">
      <!-- Folder upload icon -->
      <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M20 6h-8l-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2Zm-5 7v3h-2v-3H9l3-3 3 3h-2Z" fill="currentColor"/>
      </svg>
      <h3 style="margin:0;">Upload Excel</h3>
      <span class="badge badge-soft">.xlsx · .xls · .csv</span>
    </div>

    <!-- Quick status on uploading -->
    <div *ngIf="uploading" class="badge">Uploading…</div>
  </div>

  <!-- Single file row -->
  <div class="upload-row">
    <span class="label">Single file</span>

    <!-- Hidden native input + trigger button -->
    <input
      #singleFileInput
      id="singleFile"
      type="file"
      accept=".xlsx,.xls,.csv"
      (change)="onSingleFileChange($event)"
      aria-label="Choose a single Excel file"
      style="display:none"
    />
    <label class="btn btn-ghost" for="singleFile" title="Choose a single Excel file" aria-label="Choose a single Excel file">
      <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M14.59 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.41a2 2 0 0 0-.59-1.41L16 2.59A2 2 0 0 0 14.59 2Z" fill="currentColor"/>
      </svg>
      <span>Choose file</span>
    </label>

    <!-- Selected file summary -->
  <div class="file-info truncate" [title]="singleFile?.name || 'No file selected'">
    <ng-container *ngIf="singleFile; else noSingle">
      <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true" style="opacity:.7">
        <path d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Z" fill="currentColor"/>
      </svg>
      <!-- was: singleFile?.name -->
      <span class="file-name">{{ singleFile!.name }}</span>
    </ng-container>
    <ng-template #noSingle> No file selected </ng-template>
  </div>


    <!-- Actions -->
    <div style="margin-left:auto; display:flex; gap:8px;">
      <button
        class="btn"
        (click)="uploadSingle()"
        [disabled]="!singleFile || uploading"
        title="Upload selected file"
      >
        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M5 20h14v-2H5v2Zm7-16 5 5h-3v4h-4v-4H7l5-5Z" fill="currentColor"/>
        </svg>
        <span>Upload</span>
      </button>

      <button
        class="btn btn-ghost"
        type="button"
        (click)="clearSingle()"

        title="Clear selection"
      >
        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>
        <span>Clear</span>
      </button>
    </div>
  </div>

  <!-- Multiple files row -->
  <div class="upload-row">
    <span class="label">Multiple files</span>

    <!-- Hidden native input + trigger button -->
    <input
      #multiFilesInput
      id="multiFiles"
      type="file"
      multiple
      accept=".xlsx,.xls,.csv"
      (change)="onMultiFilesChange($event)"
      aria-label="Choose multiple Excel files"
      style="display:none"
    />
    <label class="btn btn-ghost" for="multiFiles" title="Choose multiple Excel files" aria-label="Choose multiple Excel files">
      <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M8 2h9a2 2 0 0 1 2 2v9h-2V4H8V2ZM5 6h9a2 2 0 0 1 2 2v9h-2V8H5V6ZM3 10h9a2 2 0 0 1 2 2v9H5a2 2 0 0 1-2-2v-9Z" fill="currentColor"/>
      </svg>
      <span>Choose files</span>
    </label>

    <!-- Selected files summary -->
    <div class="file-info truncate" [title]="getMultiFilesTitle()">
      <ng-container *ngIf="multiFiles.length; else noMulti">
        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true" style="opacity:.7">
          <path d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Z" fill="currentColor"/>
        </svg>
        <span class="file-name">{{ multiFiles.length }} selected</span>
        <span class="badge badge-soft" *ngIf="multiFiles[0]">{{ multiFiles[0].name }}</span>
        <span class="badge badge-soft" *ngIf="multiFiles.length>1">{{ multiFiles[1].name }}</span>
        <span class="badge" *ngIf="multiFiles.length>2">+{{ multiFiles.length - 2 }}</span>
      </ng-container>
      <ng-template #noMulti> No files selected </ng-template>
    </div>

    <!-- Actions -->
    <div style="margin-left:auto; display:flex; gap:8px;">
      <button
        class="btn"
        (click)="uploadMany()"
        [disabled]="!multiFiles.length || uploading"
        title="Upload all selected files"
      >
        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M5 20h14v-2H5v2Zm2.5-7.5L12 8l4.5 4.5h-3V17h-3v-4.5h-3Z" fill="currentColor"/>
        </svg>
        <span>Upload all</span>
      </button>

      <button
        class="btn btn-ghost"
        type="button"
        (click)="clearMulti()"
        [disabled]="!multiFiles.length || uploading"
        title="Clear selection"
      >
        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>
        <span>Clear</span>
      </button>
    </div>
  </div>

  <div class="hint">You can upload multiple Excel files at once. Max size depends on server config.</div>
</div>


  <!-- Alerts -->
  <div class="error" *ngIf="errorMsg" aria-live="assertive">
    {{ errorMsg }}
  </div>
  <div class="loading" *ngIf="loading" aria-live="polite">
    Loading files…
  </div>

  <!-- Files table -->
  <div class="table-wrap" *ngIf="!loading">
   <table>
  <thead>
    <tr>
      <th style="width:56px;">#</th>
      <th>Original name</th>
      <th style="width:120px;">Open</th>
     
      <th style="width:120px; text-align:right;">Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let f of files; let i = index">
      <td>{{ i + 1 }}</td>
      <td class="truncate">
        <span class="file-name" [title]="f.originalName">{{ f.originalName }}</span>
      </td>

      <!-- Open button column -->
      <td>
        <a
          class="btn btn-ghost"
          [href]="'http://localhost:4000' + (f.storedPath?.startsWith('/') ? f.storedPath : '/' + f.storedPath)"
          target="_blank"
          rel="noopener"
          title="Open file in a new tab"
        >
          <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3zM5 5h6v2H7v10h10v-4h2v6H5V5z" fill="currentColor"/>
          </svg>
          <span>Open</span>
        </a>
      </td>


      <!-- Actions -->
      <td style="text-align:right;">
        <button class="btn btn-danger" (click)="deleteFile(f)" title="Delete this file">
          Delete
        </button>
      </td>
    </tr>

    <tr *ngIf="files.length === 0">
      <td colspan="7" class="muted">
        No files yet. Use the “Upload” buttons above to add Excel files for this demande.
      </td>
    </tr>
  </tbody>
</table>
<div class="status-controls status-controls--left">
  <select [(ngModel)]="selectedStatut" class="status-select" aria-label="Select status">
    <option *ngFor="let status of statusOptions" [ngValue]="status.value">
      {{ status.label }}
    </option>
  </select>

  <span class="badge badge-soft" *ngIf="selectedStatut">
    {{ selectedStatusLabel }}
  </span>

  <button
    class="update-button"
    (click)="updateAllDemandeStatuses(selectedStatut!)"
    [disabled]="!selectedStatut"
    title="Apply status to this demande"
  >
    <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M13 2 3 14h7v8l11-14h-8l0-8Z" fill="currentColor"/>
    </svg>
    <span>Change state</span>
  </button>
</div>
  </div>
</div>

<ng-template #missingId>
  <div class="error">Invalid demandeId. Provide it in the route or as <code>?demandeId=</code>.</div>
</ng-template>
